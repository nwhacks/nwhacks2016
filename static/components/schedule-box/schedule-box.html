<dom-module id="schedule-box">
  <template>
    <style>
      :host {
        display: block;
      }
      .day {
        margin-top: 0;
      }
      .day table {
        width: 100%;
      }
      .day td {
        padding: 0 16px 20px;
      }
      .day td:nth-child(2) {
        width: 100%;
      }
      .day td:last-child {
        white-space: nowrap;
      }
      .card-content {
        padding: 0px 16px;
      }
      .center {
        text-align: center;
      }
      @media (min-width: 768px) {
        .day {
          width: calc(50% - 10px);
          display: inline-block;
        }
        .day:first-of-type {
          float: left;
          margin-right: 20px;
        }
      }
    </style>
    <h1>Schedule</h1>
    <div class="content">
      <template is="dom-repeat" items="[[days]]">
        <paper-card class="day" heading="[[item.name]]">
          <div class="card-content">
            <table>
              <tbody>
                <template is="dom-repeat" items="[[item.events]]">
                  <tr>
                    <td>[[item.displayTime]]</td>
                    <td>[[item.name]]</td>
                    <td><a href="[[map(item.location)]]">[[item.location]]</a></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </paper-card>
      </template>
      <div class="center">
        <a href="https://calendar.google.com/calendar/embed?src=outerearth.net_2djv2qvtpfu60m7jrcm40oannk@group.calendar.google.com&ctz=America/Los_Angeles">Google Calendar</a>
      </div>
    </div>
    <iron-ajax
      auto
      url="https://www.googleapis.com/calendar/v3/calendars/outerearth.net_2djv2qvtpfu60m7jrcm40oannk@group.calendar.google.com/events?key=%20AIzaSyAdbxoL7d-fe9rFUh898TTCx-ZERREDhKg"
      handle-as="json"
      last-response="{{gcal}}"
      debounce-duration="300"></iron-ajax>
  </template>

  <script>
Polymer({
  is: "schedule-box",
  properties: {
    days: {
      type: Array,
      computed: 'calendarDisplay(gcal)',
    },
    gcal: {
      type: Object,
      value: function() { return {}; },
    },
  },
  map: function(location) {
    return "https://fn.lc/campus/#"+location;
  },
  calendarDisplay: function() {
    console.log(this.gcal);
    if (!this.gcal.items) {
      return [];
    }
    var days = {};
    var daysArr = [];
    this.gcal.items.forEach(function(item) {
      var start = moment(item.start.dateTime);
      var dayTitle = start.format("dddd, MMM Do");
      var day = days[dayTitle];
      if (!day) {
        day = {
          name: dayTitle,
          start: start,
          events: [],
        };
        daysArr.push(day);
        days[dayTitle] = day;
      }
      var event = {
        name: item.summary,
        start: start,
        displayTime: start.format("HH:mm"),
        location: item.location,
      }
      day.events.push(event);
    });
    daysArr.sort(function(a, b) {
      return a.start - b.start;
    });
    daysArr.forEach(function(day) {
      day.events.sort(function(a, b) {
        return a.start - b.start;
      });
    });
    console.log(daysArr);
    return daysArr;
  },
});
  </script>
</dom-module>
